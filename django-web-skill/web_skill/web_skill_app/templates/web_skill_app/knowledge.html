{% extends 'web_skill_app/base.html' %}
{% load static %}
{% block title %}Knowledge - Agente de Pensamiento Cr√≠tico{% endblock %}

{% block content %}
    {% include 'web_skill_app/partials/navigation.html' with currentPage='knowledge' %}

    <div class="flex h-[calc(100vh-4rem)] pt-16 bg-slate-900 overflow-hidden">

        <aside class="w-[550px] flex flex-col bg-slate-800/90 border-r border-purple-500/30 shadow-xl z-20 relative flex-shrink-0">
            
            <div class="p-6 border-b border-purple-500/20 bg-slate-800">
                <a href="{% url 'dashboard' %}" class="flex items-center justify-center gap-2 w-full py-2 mb-6 text-sm font-semibold text-slate-300 transition-all bg-slate-700/50 rounded-lg hover:bg-red-500/20 hover:text-red-200 border border-transparent hover:border-red-500/30">
                    <span>üè† Regresar al Dashboard</span>
                </a>

                <div class="flex flex-col items-center">
                    <div class="relative w-28 h-28 mb-3">
                        <div class="absolute inset-[-4px] rounded-full bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 opacity-80 animate-pulse" id="avatar-light"></div>
                        <div class="relative w-full h-full overflow-hidden rounded-full border-4 border-slate-900">
                            <img src="https://static.vecteezy.com/system/resources/previews/036/182/403/non_2x/ai-generated-3d-cartoon-man-in-red-suit-businessman-character-on-transparent-background-png.png" alt="Agente Profesor" class="object-cover w-full h-full">
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-purple-400">üß† Agente Profesor</h3>
                    <p class="text-xs text-slate-400">Tu gu√≠a de pensamiento cr√≠tico</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/30 custom-scrollbar" id="chatMessages">
                {% if not conversation_history %}
                <div class="flex justify-start message agent">
                    <div class="max-w-[90%] px-4 py-3 rounded-xl rounded-tl-none shadow-lg bg-slate-700/80 text-slate-200 border border-purple-400/30 text-sm">
                        üëã ¬°Hola! Soy tu Coach. Mientras estudias la lecci√≥n a la derecha, puedes preguntarme lo que quieras aqu√≠.
                    </div>
                </div>
                {% endif %}

                {% for message in conversation_history %}
                    <div class="flex {% if message.role == 'user' %}justify-end{% else %}justify-start{% endif %} message animate-fadeIn">
                        <div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm {% if message.role == 'user' %}bg-gradient-to-br from-blue-700 to-cyan-600 text-white rounded-tr-none{% else %}bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none{% endif %}">
                            <div class="message-text">{{ message.message|safe }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="p-4 bg-slate-800 border-t border-purple-500/20">
                <form class="flex gap-2" id="chat-form" method="post" action="{% url 'chat_knowledge' %}">
                    {% csrf_token %}
                    <input type="text" name="user_message" class="flex-1 px-4 py-2 text-sm text-white bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-slate-500 transition-all" id="messageInput" placeholder="Pregunta sobre la lecci√≥n..." autocomplete="off" required>
                    <button type="button" id="micBtn" class="p-2 text-white bg-slate-700/50 border border-slate-600 rounded-lg hover:bg-purple-600/30 transition-all">
                        <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <button type="submit" class="p-2 text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50" id="sendButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </aside>

        <main class="flex-1 flex bg-slate-900 relative overflow-hidden">
            
            <div class="w-72 bg-slate-800/50 border-r border-purple-500/20 flex flex-col overflow-y-auto custom-scrollbar flex-shrink-0">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <span>üìö</span> Temario
                    </h2>

                    {% for pilar_num in "12345" %}
                    <div class="mb-4 pilar-section">
                        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-slate-700 to-slate-800 rounded-lg border border-slate-600 cursor-pointer hover:border-purple-500 transition-all group" onclick="togglePilar(this)">
                            <span class="font-semibold text-slate-200 text-sm group-hover:text-white">
                                {% if pilar_num == '1' %}üéØ{% elif pilar_num == '2' %}üîç{% elif pilar_num == '3' %}üí°{% elif pilar_num == '4' %}üó£Ô∏è{% elif pilar_num == '5' %}üîÑ{% endif %}
                                Pilar {{ pilar_num }}
                            </span>
                            <span class="text-xs text-slate-400 pilar-arrow transition-transform duration-300">‚ñº</span>
                        </div>
                        
                        <div class="pilar-lessons max-h-0 overflow-hidden transition-[max-height] duration-300 ease-out bg-slate-900/30 rounded-b-lg mx-1">
                            {% for leccion_num in "123" %}
                                <a href="#" class="flex items-center justify-between p-3 my-1 text-sm text-slate-400 hover:text-white hover:bg-purple-500/20 border-l-2 border-transparent hover:border-purple-500 transition-all lesson-link" onclick="cargarLeccion('{{ pilar_num }}.{{ leccion_num }}'); return false;">
                                    <span>üìñ Lecci√≥n {{ pilar_num }}.{{ leccion_num }}</span>
                                    <div class="w-4 h-4 rounded border border-slate-600 bg-slate-800"></div>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                    
                
            </div>

            <div class="flex-1 p-6 lg:p-8 overflow-hidden relative bg-gradient-to-br from-slate-900 via-[#1a1033] to-slate-900" id="main-scroll">
                
                <div class="w-full h-full bg-slate-800/40 backdrop-blur-sm border border-white/5 rounded-2xl shadow-2xl p-8 text-slate-200 flex flex-col justify-between overflow-y-auto custom-scrollbar" id="pizarra-content">
                    
                    <div class="w-full h-full flex flex-col justify-between">
                        {% if leccion_content %}
                            {% include leccion_content %}
                        {% else %}
                            <div class="flex flex-col items-center justify-center h-full text-center opacity-80">
                                <div class="text-6xl mb-6">üéì</div>
                                <h1 class="text-3xl font-bold text-white mb-4">Bienvenido a tu Aula Virtual</h1>
                                <p class="text-lg text-slate-300 max-w-xl">
                                    Selecciona un Pilar en el men√∫ de la izquierda para comenzar.
                                </p>
                            </div>
                        {% endif %}
                    </div>

                </div>
            </div>

        </main>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(107, 114, 128, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.6); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Forzamos que el √∫ltimo hijo directo del contenido de la lecci√≥n (asumiendo que son los botones)
           tenga margen superior autom√°tico para pegarse al fondo si el texto es corto */
        #pizarra-content > div > *:last-child {
            margin-top: auto;
            padding-top: 2rem; /* Espacio extra para separar del texto */
        }

        .pilar-section.open .pilar-lessons { max-height: 500px; }
        .pilar-section.open .pilar-arrow { transform: rotate(180deg); }
        
        .lesson-link.active { background-color: rgba(147, 51, 234, 0.2); border-left-color: #9333ea; color: white; }
        .lesson-link.active div { background-color: #9333ea; border-color: #9333ea; }

        @keyframes speaking { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }
        .speaking-animation { animation: speaking 1.5s ease-in-out infinite; }
        
        .typing-dot { animation: bounce 1.4s infinite both; height: 6px; width: 6px; background-color: #94a3b8; border-radius: 50%; display: inline-block; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>

    <script>
        const micBtn = document.getElementById('micBtn'); // Aseg√∫rate de que el bot√≥n en el HTML tenga este ID
        let mediaRecorder;
        let audioChunks = [];
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const avatarLight = document.getElementById('avatar-light');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const synth = window.speechSynthesis;
        let leccion_actual = "0.0";

        window.onload = () => { chatMessages.scrollTop = chatMessages.scrollHeight; }

        function togglePilar(header) {
            const section = header.parentElement;
            const isOpen = section.classList.contains('open');
            document.querySelectorAll('.pilar-section').forEach(s => s.classList.remove('open'));
            if (!isOpen) section.classList.add('open');
        }

        function cargarLeccion(codigo) {
            leccion_actual = codigo;
            document.querySelectorAll('.lesson-link').forEach(l => l.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            const pizarraContent = document.getElementById("pizarra-content");
            // Mantenemos la estructura flex para el cargando
            pizarraContent.innerHTML = '<div class="w-full h-full flex items-center justify-center text-purple-300 animate-pulse"><div class="text-center"><span class="text-4xl block mb-2">‚è≥</span><span>Cargando lecci√≥n...</span></div></div>';

            fetch(`/lecciones/${codigo}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Error de red");
                    return response.text();
                })
                .then(html => {
                    // Inyectamos y envolvemos en el div flex para asegurar el sticky footer
                    pizarraContent.innerHTML = `<div class="w-full h-full flex flex-col justify-between">${html}</div>`;
                    
                    const scripts = pizarraContent.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        document.body.appendChild(newScript);
                        setTimeout(() => newScript.remove(), 100); 
                    });
                })
                .catch(err => {
                    pizarraContent.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">Error: ${err.message}</div>`;
                });
        }

        function saltarLeccion(){
            let parte = leccion_actual.split('.');
            let pilar = parseInt(parte[0]);
            let leccion = parseInt(parte[1]);
            if (leccion < 3) {
                // Si hay m√°s lecciones en el mismo pilar, sumamos 1 a la lecci√≥n
                leccion++;
            } else if (pilar < 5) {
                // Si terminamos las 3 lecciones, pasamos al siguiente pilar y lecci√≥n 1
                pilar++;
                leccion = 1;
            }
            // 3. Creamos el nuevo c√≥digo (ej: "1.3")
            const siguienteCodigo = `${pilar}.${leccion}`;
            
            // 4. Ejecutamos la carga
            cargarLeccion(siguienteCodigo);
            
            // 5. (Opcional) Abrir el men√∫ lateral autom√°ticamente para que coincida
            actualizarMenuLateral(pilar, siguienteCodigo);
        }
        function actualizarMenuLateral(pilarNum, codigoCompleto) {
            // Abrir el acorde√≥n del pilar si est√° cerrado
            const pilarHeader = document.querySelector(`.pilar-section:nth-child(${pilarNum}) .cursor-pointer`);
            const pilarSection = pilarHeader?.parentElement;
            if (pilarSection && !pilarSection.classList.contains('open')) {
                togglePilar(pilarHeader);
            }
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            if (synth.speaking) synth.cancel();

            addMessage('user', text);
            chatInput.value = '';
            const loadingId = addLoadingIndicator();

            try {
                const res = await fetch(chatForm.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ user_message: text })
                });
                const data = await res.json();
                removeMessage(loadingId);
                if (data.status === 'ok') {
                    handleAgentResponse(data.agent_response);
                } else {
                    addMessage('agent', '‚ö†Ô∏è Error: ' + (data.error || 'Desconocido'));
                }
            } catch (err) {
                removeMessage(loadingId);
                addMessage('agent', '‚ö†Ô∏è Error de conexi√≥n.');
            }
        });

        function addMessage(role, text) {
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message animate-fadeIn`;
            const bubbleClass = isUser ? 'bg-gradient-to-br from-blue-700 to-cyan-600 text-white rounded-tr-none' : 'bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none';
            div.innerHTML = `<div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm ${bubbleClass}"><div class="message-text">${text}</div></div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex justify-start message animate-fadeIn';
            div.innerHTML = `<div class="px-4 py-3 rounded-xl bg-slate-700/80 border border-purple-400/30 rounded-tl-none"><div class="flex space-x-1"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeMessage(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function handleAgentResponse(text) {
            avatarLight.classList.add('speaking-animation');
            const div = document.createElement('div');
            div.className = `flex justify-start message animate-fadeIn`;
            div.innerHTML = `<div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none"><div class="message-text agent-text-content"></div></div>`;
            chatMessages.appendChild(div);
            const textContainer = div.querySelector('.agent-text-content');
            let i = 0;
            function type() {
                if (i < text.length) { textContainer.innerHTML += text.charAt(i); i++; chatMessages.scrollTop = chatMessages.scrollHeight; setTimeout(type, 15); }
            }
            type();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'es-ES';
            utter.onend = () => avatarLight.classList.remove('speaking-animation');
            synth.speak(utter);
        }
        // L√≥gica para grabar audio al mantener presionado
micBtn.addEventListener('mousedown', async () => {
    try {
        // 1. Primero obtenemos el stream del micr√≥fono
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // 2. Definimos las opciones de formato
        const options = { mimeType: 'audio/webm;codecs=opus' };
        
        // 3. Verificamos si el navegador soporta el formato y creamos el recorder
        if (MediaRecorder.isTypeSupported(options.mimeType)) {
            mediaRecorder = new MediaRecorder(stream, options);
        } else {
            // Si no soporta opus, dejamos que el navegador use su formato por defecto
            mediaRecorder = new MediaRecorder(stream);
        }

        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = async () => {
            // Importante: Aunque el navegador grabe en webm, 
            // enviamos el blob con el tipo que el navegador gener√≥.
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            console.log("Grabaci√≥n finalizada. Tama√±o:", audioBlob.size, "bytes");
            await transcribeAndProcess(audioBlob);
        };

        // 4. Iniciar la grabaci√≥n
        mediaRecorder.start();
        
        // Feedback visual
        micBtn.classList.add('bg-red-500/50', 'animate-pulse'); 
        if (avatarLight) avatarLight.classList.add('speaking-animation');

    } catch (err) {
        console.error("Error al acceder al micr√≥fono:", err);
        addMessage('agent', '‚ö†Ô∏è No se pudo acceder al micr√≥fono. Revisa los permisos.');
    }
});
micBtn.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        micBtn.classList.remove('bg-red-500/50', 'animate-pulse');
    }
});

// Funci√≥n para enviar audio al servidor y luego al chat
async function transcribeAndProcess(blob) {
    if (blob.size < 1000) {
        addMessage('agent', '‚ö†Ô∏è El audio es muy corto, intenta hablar un poco m√°s.');
        return;
    }
    const formData = new FormData();
    formData.append('audio_data', blob, 'recording.webm');

    // Mostramos un indicador de que estamos "escribiendo" la transcripci√≥n
    const loadingId = addLoadingIndicator();

    try {
        const response = await fetch('/transcribe/', { 
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken // Reutilizamos tu variable csrfToken
            }
        });

        const data = await response.json();
        removeMessage(loadingId);

        if (data.text && data.text.trim() !== "") {
            // Insertamos el texto en tu input actual
            chatInput.value = data.text;
            
            // Disparamos el evento submit de tu formulario para que siga tu l√≥gica original
            chatForm.requestSubmit(); 
        } else {
            addMessage('agent', '‚ö†Ô∏è No pude entender el audio, intenta de nuevo.');
        }
    } catch (error) {
        removeMessage(loadingId);
        console.error("Error en transcripci√≥n:", error);
        addMessage('agent', '‚ö†Ô∏è Error al procesar el audio.');
    }
}
    </script>
{% endblock %}