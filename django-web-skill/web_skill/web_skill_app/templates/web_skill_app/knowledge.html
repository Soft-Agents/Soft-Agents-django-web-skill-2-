{% extends 'web_skill_app/base.html' %}
{% load static %}
{% block title %}Knowledge - Agente de Pensamiento Cr√≠tico{% endblock %}

{% block content %}
    {% include 'web_skill_app/partials/navigation.html' with currentPage='knowledge' %}

    <div class="flex h-[calc(100vh-4rem)] pt-16 bg-slate-900 overflow-hidden">

        <aside class="w-[550px] flex flex-col bg-slate-800/90 border-r border-purple-500/30 shadow-xl z-20 relative flex-shrink-0">
            
            <div class="p-6 border-b border-purple-500/20 bg-slate-800">
                <a href="{% url 'dashboard' %}" class="flex items-center justify-center gap-2 w-full py-2 mb-6 text-sm font-semibold text-slate-300 transition-all bg-slate-700/50 rounded-lg hover:bg-red-500/20 hover:text-red-200 border border-transparent hover:border-red-500/30">
                    <span>üè† Regresar al Dashboard</span>
                </a>

                <div class="flex flex-col items-center">
                    <div class="relative w-28 h-28 mb-3 group">
    <div class="absolute inset-[-4px] rounded-full bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 opacity-80 animate-pulse" id="avatar-light"></div>
    
    <div class="relative w-full h-full overflow-hidden rounded-full border-4 border-slate-900">
        <img src="https://static.vecteezy.com/system/resources/previews/036/182/403/non_2x/ai-generated-3d-cartoon-man-in-red-suit-businessman-character-on-transparent-background-png.png" alt="Agente Profesor" class="object-cover w-full h-full">
    </div>

    <button id="toggleMuteBtn" class="absolute top-0 right-0 transform translate-x-2 -translate-y-1 bg-slate-800 border border-slate-600 text-slate-300 p-1.5 rounded-full hover:bg-purple-600 hover:text-white hover:border-purple-400 transition-all shadow-lg z-20" title="Activar/Desactivar Voz">
        <svg id="icon-vol-on" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg id="icon-vol-off" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>
</div>
                    <h3 class="text-lg font-bold text-purple-400">üß† Agente Yashay</h3>
                    <p class="text-xs text-slate-400">Tu gu√≠a de pensamiento cr√≠tico</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/30 custom-scrollbar" id="chatMessages">
                {% if not conversation_history %}
                <div class="flex justify-start message agent">
                    <div class="max-w-[90%] px-4 py-3 rounded-xl rounded-tl-none shadow-lg bg-slate-700/80 text-slate-200 border border-purple-400/30 text-sm">
                        üëã ¬°Hola! Soy tu Coach. Mientras estudias la lecci√≥n a la derecha, puedes preguntarme lo que quieras aqu√≠.
                    </div>
                </div>
                {% endif %}

                {% for message in conversation_history %}
                    <div class="flex {% if message.role == 'user' %}justify-end{% else %}justify-start{% endif %} message animate-fadeIn">
                        <div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm {% if message.role == 'user' %}bg-gradient-to-br from-blue-700 to-cyan-600 text-white rounded-tr-none{% else %}bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none{% endif %}">
                            <div class="message-text">{{ message.message|safe }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="p-4 bg-slate-800 border-t border-purple-500/20">
                <form class="flex gap-2" id="chat-form" method="post" action="{% url 'chat_knowledge' %}">
                    {% csrf_token %}
                    <input type="text" name="user_message" class="flex-1 px-4 py-2 text-sm text-white bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-slate-500 transition-all" id="messageInput" placeholder="Pregunta sobre la lecci√≥n..." autocomplete="off" required>
                    <button type="button" id="micBtn" class="p-2 text-white bg-slate-700/50 border border-slate-600 rounded-lg hover:bg-purple-600/30 transition-all">
                        <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <button type="submit" class="p-2 text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50" id="sendButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </aside>

        <main class="flex-1 flex bg-slate-900 relative overflow-hidden">
    
    <div id="temario-sidebar" class="w-72 bg-slate-800/50 border-r border-purple-500/20 flex flex-col overflow-y-auto custom-scrollbar flex-shrink-0 transition-all duration-300 ease-in-out relative">
        <div class="p-6 min-w-[18rem]"> <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>üìö</span> Temario
                </h2>
            </div>

            {% for pilar_num in "12345" %}
            <div class="mb-4 pilar-section">
                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-slate-700 to-slate-800 rounded-lg border border-slate-600 cursor-pointer hover:border-purple-500 transition-all group" onclick="togglePilar(this)">
                    <span class="font-semibold text-slate-200 text-sm group-hover:text-white">
                        {% if pilar_num == '1' %}üéØ{% elif pilar_num == '2' %}üîç{% elif pilar_num == '3' %}üí°{% elif pilar_num == '4' %}üó£Ô∏è{% elif pilar_num == '5' %}üîÑ{% endif %}
                        Pilar {{ pilar_num }}
                    </span>
                    <span class="text-xs text-slate-400 pilar-arrow transition-transform duration-300">‚ñº</span>
                </div>
                
                <div class="pilar-lessons max-h-0 overflow-hidden transition-[max-height] duration-300 ease-out bg-slate-900/30 rounded-b-lg mx-1">
                    {% for leccion_num in "123" %}
                        {% with leccion_id=pilar_num|add:"."|add:leccion_num %}
<a href="#" class="flex items-center justify-between p-3 my-1 text-sm text-slate-400 hover:text-white hover:bg-purple-500/20 border-l-2 border-transparent hover:border-purple-500 transition-all lesson-link" onclick="cargarLeccion('{{ leccion_id }}'); return false;">
    <span class="flex items-center gap-2">
        <div id="check-{{ leccion_id }}" class="w-4 h-4 rounded border border-slate-500 flex items-center justify-center transition-colors lesson-checkbox">
            <svg class="w-3 h-3 text-white hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
        </div>
        Lecci√≥n {{ leccion_id }}
    </span>
</a>
{% endwith %}
                    {% endfor %}
                </div>
                
                    
                
            </div>
            {% endfor %}
        </div>
    </div>

    <button id="temario-toggle" onclick="toggleTemario()" class="absolute top-6 left-72 z-20 w-6 h-12 flex items-center justify-center bg-slate-700 text-slate-300 rounded-r-md border-y border-r border-slate-600 hover:bg-purple-600 hover:text-white hover:border-purple-500 shadow-lg transition-all duration-300 ease-in-out group" title="Ocultar/Mostrar Temario">
        <svg id="icon-collapse" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="transform group-hover:-translate-x-0.5 transition-transform">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <svg id="icon-expand" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hidden transform group-hover:translate-x-0.5 transition-transform">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>

    <div class="flex-1 p-6 lg:p-8 overflow-hidden relative bg-gradient-to-br from-slate-900 via-[#1a1033] to-slate-900" id="main-scroll">
        
        <div class="w-full h-full bg-slate-800/40 backdrop-blur-sm border border-white/5 rounded-2xl shadow-2xl p-8 text-slate-200 flex flex-col justify-between overflow-y-auto custom-scrollbar" id="pizarra-content">
            
            <div class="w-full h-full flex flex-col justify-between">
                {% if leccion_content %}
                    {% include leccion_content %}
                {% else %}
                    <div class="flex flex-col items-center justify-center h-full text-center opacity-80">
                        <div class="text-6xl mb-6">üéì</div>
                        <h1 class="text-3xl font-bold text-white mb-4">Bienvenido a tu Aula Virtual</h1>
                        <p class="text-lg text-slate-300 max-w-xl">
                            Selecciona un Pilar en el men√∫ de la izquierda para comenzar.
                        </p>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>

</main>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(107, 114, 128, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.6); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Forzamos que el √∫ltimo hijo directo del contenido de la lecci√≥n (asumiendo que son los botones)
           tenga margen superior autom√°tico para pegarse al fondo si el texto es corto */
        #pizarra-content > div > *:last-child {
            margin-top: auto;
            padding-top: 2rem; /* Espacio extra para separar del texto */
        }

        .pilar-section.open .pilar-lessons { max-height: 500px; }
        .pilar-section.open .pilar-arrow { transform: rotate(180deg); }
        
        .lesson-link.active { background-color: rgba(147, 51, 234, 0.2); border-left-color: #9333ea; color: white; }
        .lesson-link.active div { background-color: #9333ea; border-color: #9333ea; }

        @keyframes speaking { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }
        .speaking-animation { animation: speaking 1.5s ease-in-out infinite; }
        
        .typing-dot { animation: bounce 1.4s infinite both; height: 6px; width: 6px; background-color: #94a3b8; border-radius: 50%; display: inline-block; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* ESTILOS PARA CHECKBOX MARCADO */
.lesson-checkbox.checked { background-color: #10b981; border-color: #10b981; } /* Verde */
.lesson-checkbox.checked .check-icon { display: block; }
    </style>

    <script>
        const micBtn = document.getElementById('micBtn'); // Aseg√∫rate de que el bot√≥n en el HTML tenga este ID
        let mediaRecorder;
        let audioChunks = [];
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const avatarLight = document.getElementById('avatar-light');
        // Aseguramos que existe el token antes de leerlo
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const synth = window.speechSynthesis;
        let leccion_actual = "0.0";

// --- L√ìGICA DE PAUSA / REANUDAR ---
    const muteBtn = document.getElementById('toggleMuteBtn');
    const iconOn = document.getElementById('icon-vol-on');
    const iconOff = document.getElementById('icon-vol-off');
    
    // Leemos preferencia
    let isMuted = localStorage.getItem('agentMuted') === 'true';

    // Funci√≥n solo para actualizar los iconos visualmente
    function updateIconsUI() {
        if (isMuted) {
            iconOn.classList.add('hidden');
            iconOff.classList.remove('hidden');
            muteBtn.classList.add('text-red-400', 'border-red-400/50');
        } else {
            iconOff.classList.add('hidden');
            iconOn.classList.remove('hidden');
            muteBtn.classList.remove('text-red-400', 'border-red-400/50');
        }
    }

        function cargarLeccion(codigo) {
            leccion_actual = codigo;
            document.querySelectorAll('.lesson-link').forEach(l => l.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            const pizarraContent = document.getElementById("pizarra-content");
            // Mantenemos la estructura flex para el cargando
            pizarraContent.innerHTML = '<div class="w-full h-full flex items-center justify-center text-purple-300 animate-pulse"><div class="text-center"><span class="text-4xl block mb-2">‚è≥</span><span>Cargando lecci√≥n...</span></div></div>';

            fetch(`/lecciones/${codigo}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Error de red");
                    return response.text();
                })
                .then(html => {
                    // Inyectamos y envolvemos en el div flex para asegurar el sticky footer
                    pizarraContent.innerHTML = `<div class="w-full h-full flex flex-col justify-between">${html}</div>`;
                    
                    const scripts = pizarraContent.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        document.body.appendChild(newScript);
                        setTimeout(() => newScript.remove(), 100); 
                    });
                })
                .catch(err => {
                    pizarraContent.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">Error: ${err.message}</div>`;
                });
        }

        function saltarLeccion(){
            let parte = leccion_actual.split('.');
            let pilar = parseInt(parte[0]);
            let leccion = parseInt(parte[1]);
            if (leccion < 3) {
                // Si hay m√°s lecciones en el mismo pilar, sumamos 1 a la lecci√≥n
                leccion++;
            } else if (pilar < 5) {
                // Si terminamos las 3 lecciones, pasamos al siguiente pilar y lecci√≥n 1
                pilar++;
                leccion = 1;
            }
            // 3. Creamos el nuevo c√≥digo (ej: "1.3")
            const siguienteCodigo = `${pilar}.${leccion}`;
            
            // 4. Ejecutamos la carga
            cargarLeccion(siguienteCodigo);
            
            // 5. (Opcional) Abrir el men√∫ lateral autom√°ticamente para que coincida
            actualizarMenuLateral(pilar, siguienteCodigo);
        }
        function actualizarMenuLateral(pilarNum, codigoCompleto) {
            // Abrir el acorde√≥n del pilar si est√° cerrado
            const pilarHeader = document.querySelector(`.pilar-section:nth-child(${pilarNum}) .cursor-pointer`);
            const pilarSection = pilarHeader?.parentElement;
            if (pilarSection && !pilarSection.classList.contains('open')) {
                togglePilar(pilarHeader);
            }
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            if (synth.speaking) synth.cancel();

            addMessage('user', text);
            chatInput.value = '';
            const loadingId = addLoadingIndicator();

            try {
                const res = await fetch(chatForm.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ user_message: text })
                });
                const data = await res.json();
                removeMessage(loadingId);
                if (data.status === 'ok') {
                    handleAgentResponse(data.agent_response);
                } else {
                    addMessage('agent', '‚ö†Ô∏è Error: ' + (data.error || 'Desconocido'));
                }
            } catch (err) {
                removeMessage(loadingId);
                addMessage('agent', '‚ö†Ô∏è Error de conexi√≥n.');
    // Inicializar iconos
    updateIconsUI();

    muteBtn.addEventListener('click', (e) => {
        e.preventDefault();
        isMuted = !isMuted;
        localStorage.setItem('agentMuted', isMuted); // Guardar preferencia
        updateIconsUI();

        // L√≥gica de Audio: PAUSA vs REANUDAR
        if (isMuted) {
            // Si est√° hablando, lo PAUSAMOS (no cancelar)
            if (synth.speaking) {
                synth.pause();
                avatarLight.classList.remove('speaking-animation'); // Detener luz
            }
        } else {
            // Si estaba pausado, lo REANUDAMOS
            if (synth.paused) {
                synth.resume();
                avatarLight.classList.add('speaking-animation'); // Reanudar luz
            }
        }
    });
    // ----------------------

// Recuperamos la lista de lecciones completadas desde Django
const completedLessons = JSON.parse('{{ completed_lessons_json|safe }}');

        window.onload = () => { chatMessages.scrollTop = chatMessages.scrollHeight;
    // Recorrer las lecciones completadas y marcar sus checkbox
    completedLessons.forEach(id => {
        markCheckboxVisual(id);
    });
        }

        // Funci√≥n que busca el cuadradito en el men√∫ y lo marca
function markCheckboxVisual(id) {
    // Busca el div con id="check-1.1", "check-1.2", etc.
    const checkContainer = document.getElementById(`check-${id}`);
    
    if (checkContainer) {
        // Le agrega la clase .checked (que pusimos en el CSS con fondo verde)
        checkContainer.classList.add('checked');
        
        // Busca el icono SVG oculto dentro y lo muestra
        const icon = checkContainer.querySelector('.check-icon');
        if (icon) icon.classList.remove('hidden');
    }
}

    function togglePilar(header) {
        const section = header.parentElement;
        const isOpen = section.classList.contains('open');
        document.querySelectorAll('.pilar-section').forEach(s => s.classList.remove('open'));
        if (!isOpen) section.classList.add('open');
    }

    // --- REEMPLAZA TU FUNCI√ìN 'cargarLeccion' POR ESTA NUEVA ---

function cargarLeccion(codigo) {
    // 1. Resaltar en el men√∫
    document.querySelectorAll('.lesson-link').forEach(l => l.classList.remove('active'));
    if (event && event.currentTarget) event.currentTarget.classList.add('active');

    // 2. Mostrar spinner de carga
    const pizarraContent = document.getElementById("pizarra-content");
    pizarraContent.innerHTML = '<div class="w-full h-full flex items-center justify-center text-purple-300 animate-pulse"><div class="text-center"><span class="text-4xl block mb-2">‚è≥</span><span>Cargando lecci√≥n...</span></div></div>';

    // 3. Petici√≥n al servidor
    fetch(`/lecciones/${codigo}/`)
        .then(response => {
            if (!response.ok) throw new Error("Error de red");
            return response.text();
        })
        .then(html => {
            // --- L√ìGICA DEL BOT√ìN UNIFICADA ---
            const isCompleted = completedLessons.includes(codigo);
            
            // Definimos TEXTO y COLOR seg√∫n estado
            const btnText = isCompleted ? "‚úÖ Lecci√≥n Completada" : "üèÜ Finalizar Lecci√≥n";
            const btnColorClass = isCompleted 
                ? "bg-green-600 cursor-default opacity-80" 
                : "bg-gradient-to-r from-purple-600 to-pink-600 hover:opacity-90 hover:scale-105";
            const btnDisabled = isCompleted ? "disabled" : "";

            // --- CORRECCI√ìN CLAVE ---
            // Aseguramos que el bot√≥n SIEMPRE nazca con 'hidden' y 'js-finish-btn'.
            // As√≠, el script de la lecci√≥n (leccionX.X.html) podr√° encontrarlo y mostrarlo solo en el slide 15.
            
            const contentWithButton = `
                <div class="w-full h-full flex flex-col justify-between fade-in">
                    <div class="prose prose-invert max-w-none overflow-y-auto custom-scrollbar pr-2">
                        ${html}
                    </div>
                    <div class="mt-6 flex justify-center pt-4 border-t border-white/10">
                        <button 
                            id="btn-finish-${codigo}"
                            onclick="finalizarLeccion('${codigo}')" 
                            class="px-8 py-3 rounded-full font-bold text-white shadow-lg transition-all transform ${btnColorClass} hidden js-finish-btn"
                            ${btnDisabled}
                        >
                            ${btnText}
                        </button>
                    </div>
                </div>
            `;
            
            pizarraContent.innerHTML = contentWithButton;
            
            // 4. Ejecutar scripts de la lecci√≥n (CRUCIAL para que funcione el slide show)
            const scripts = pizarraContent.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                document.body.appendChild(newScript);
                setTimeout(() => newScript.remove(), 100); 
            });
        })
        .catch(err => {
            pizarraContent.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">Error: ${err.message}</div>`;
        });
}

function finalizarLeccion(codigo) {
    const btn = document.getElementById(`btn-finish-${codigo}`);
    const originalText = btn.innerHTML; // Guardamos texto por si falla
    btn.innerHTML = "Guardando...";
    btn.disabled = true;

    fetch("{% url 'marcar_leccion_completada' %}", {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken 
        },
        body: JSON.stringify({ leccion_id: codigo })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            // 1. Marcar checkbox visualmente
            markCheckboxVisual(codigo);

            // 2. Actualizar bot√≥n a estado VERDE (Completado)
            btn.innerHTML = "‚úÖ Lecci√≥n Completada";
            
            // CAMBIO IMPORTANTE: Usamos classList para no borrar 'js-finish-btn' ni 'hidden' (si estuviera)
            // Quitamos estilos del bot√≥n morado
            btn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600', 'hover:opacity-90', 'hover:scale-105');
            // A√±adimos estilos del bot√≥n verde
            btn.classList.add('bg-green-600', 'cursor-default', 'opacity-80');
            
            // 3. Agregar a lista local
            if (!completedLessons.includes(codigo)) completedLessons.push(codigo);
            
            // 4. Feedback
            addMessage('agent', `¬°Felicidades! Has completado la lecci√≥n ${codigo}. üöÄ`);
        } else {
            // Si hubo error l√≥gico
            btn.innerHTML = originalText;
            btn.disabled = false;
            addMessage('agent', '‚ö†Ô∏è Hubo un problema al guardar el progreso.');
        }
    })
    .catch(err => {
        console.error(err);
        btn.innerHTML = originalText; // Restaurar texto
        btn.disabled = false;
        addMessage('agent', '‚ö†Ô∏è Error de conexi√≥n.');
    });
}

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        
        // Si el usuario escribe, cancelamos lo anterior para hablar lo nuevo
        if (synth.speaking) synth.cancel();

        addMessage('user', text);
        chatInput.value = '';
        const loadingId = addLoadingIndicator();

        try {
            const res = await fetch(chatForm.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ user_message: text })
            });
            const data = await res.json();
            removeMessage(loadingId);
            if (data.status === 'ok') {
                handleAgentResponse(data.agent_response);
            } else {
                addMessage('agent', '‚ö†Ô∏è Error: ' + (data.error || 'Desconocido'));
            }
        } catch (err) {
            removeMessage(loadingId);
            addMessage('agent', '‚ö†Ô∏è Error de conexi√≥n.');
        }
    });

    function addMessage(role, text) {
        const isUser = role === 'user';
        const div = document.createElement('div');
        div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message animate-fadeIn`;
        const bubbleClass = isUser ? 'bg-gradient-to-br from-blue-700 to-cyan-600 text-white rounded-tr-none' : 'bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none';
        div.innerHTML = `<div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm ${bubbleClass}"><div class="message-text">${text}</div></div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLoadingIndicator() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex justify-start message animate-fadeIn';
        div.innerHTML = `<div class="px-4 py-3 rounded-xl bg-slate-700/80 border border-purple-400/30 rounded-tl-none"><div class="flex space-x-1"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return id;
    }

    function removeMessage(id) { const el = document.getElementById(id); if (el) el.remove(); }

    function handleAgentResponse(text) {
        const div = document.createElement('div');
        div.className = `flex justify-start message animate-fadeIn`;
        div.innerHTML = `<div class="max-w-[90%] px-4 py-3 rounded-xl shadow-lg text-sm bg-slate-700/80 text-slate-200 border border-purple-400/30 rounded-tl-none"><div class="message-text agent-text-content"></div></div>`;
        chatMessages.appendChild(div);
        const textContainer = div.querySelector('.agent-text-content');
        
        // Efecto de escritura (visual)
        let i = 0;
        function type() {
            if (i < text.length) { 
                textContainer.innerHTML += text.charAt(i); 
                i++; 
                chatMessages.scrollTop = chatMessages.scrollHeight; 
                setTimeout(type, 15); 
            }
        }
        type();

        // Configuraci√≥n de voz
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'es-ES';
        
        // Eventos para controlar la luz del avatar
        utter.onstart = () => {
            if (!isMuted) avatarLight.classList.add('speaking-animation');
        };
        utter.onend = () => {
            avatarLight.classList.remove('speaking-animation');
        };
        utter.onpause = () => {
            avatarLight.classList.remove('speaking-animation');
        };
        utter.onresume = () => {
            avatarLight.classList.add('speaking-animation');
        };

        // Si NO est√° muteado, habla inmediatamente.
        // Si EST√Å muteado, no hacemos speak() porque se acumular√≠a en cola y es molesto.
        // (Nota: La funci√≥n "Pausa" solo aplica si muteas MIENTRAS habla. 
        // Si ya estabas muteado al recibir el mensaje, el mensaje es solo texto).
        if (!isMuted) {
            synth.speak(utter);
        }
        // L√≥gica para grabar audio al mantener presionado
micBtn.addEventListener('mousedown', async () => {
    try {
        // 1. Primero obtenemos el stream del micr√≥fono
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // 2. Definimos las opciones de formato
        const options = { mimeType: 'audio/webm;codecs=opus' };
        
        // 3. Verificamos si el navegador soporta el formato y creamos el recorder
        if (MediaRecorder.isTypeSupported(options.mimeType)) {
            mediaRecorder = new MediaRecorder(stream, options);
        } else {
            // Si no soporta opus, dejamos que el navegador use su formato por defecto
            mediaRecorder = new MediaRecorder(stream);
        }

        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = async () => {
            // Importante: Aunque el navegador grabe en webm, 
            // enviamos el blob con el tipo que el navegador gener√≥.
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            console.log("Grabaci√≥n finalizada. Tama√±o:", audioBlob.size, "bytes");
            await transcribeAndProcess(audioBlob);
        };

        // 4. Iniciar la grabaci√≥n
        mediaRecorder.start();
        
        // Feedback visual
        micBtn.classList.add('bg-red-500/50', 'animate-pulse'); 
        if (avatarLight) avatarLight.classList.add('speaking-animation');

    } catch (err) {
        console.error("Error al acceder al micr√≥fono:", err);
        addMessage('agent', '‚ö†Ô∏è No se pudo acceder al micr√≥fono. Revisa los permisos.');
    }
});
micBtn.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        micBtn.classList.remove('bg-red-500/50', 'animate-pulse');
    }
});

// Funci√≥n para enviar audio al servidor y luego al chat
async function transcribeAndProcess(blob) {
    if (blob.size < 1000) {
        addMessage('agent', '‚ö†Ô∏è El audio es muy corto, intenta hablar un poco m√°s.');
        return;
    }
    const formData = new FormData();
    formData.append('audio_data', blob, 'recording.webm');

    // Mostramos un indicador de que estamos "escribiendo" la transcripci√≥n
    const loadingId = addLoadingIndicator();

    try {
        const response = await fetch('/transcribe/', { 
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken // Reutilizamos tu variable csrfToken
            }
        });

        const data = await response.json();
        removeMessage(loadingId);

        if (data.status === 'ok' && data.text) {
            chatInput.value = data.text;
            chatForm.requestSubmit(); 
        } else {
            // Ahora mostramos el mensaje real que manda el servidor (data.message)
            const errorReal = data.message || 'No pude entender el audio.';
            addMessage('agent', '‚ö†Ô∏è ' + errorReal);
        }
    } catch (error) {
        removeMessage(loadingId);
        console.error("Error en transcripci√≥n:", error);
        addMessage('agent', '‚ö†Ô∏è Error al procesar el audio.');
    }
}
    }

    // --- L√ìGICA DEL TEMARIO (Sidebar) ---
    function toggleTemario() {
        const sidebar = document.getElementById('temario-sidebar');
        const toggleBtn = document.getElementById('temario-toggle');
        const iconCollapse = document.getElementById('icon-collapse');
        const iconExpand = document.getElementById('icon-expand');

        // Verificamos si tiene ancho (est√° abierto)
        const isOpen = sidebar.classList.contains('w-72');

        if (isOpen) {
            // CERRAR
            sidebar.classList.remove('w-72');
            sidebar.classList.add('w-0', 'border-none'); // Quitamos ancho y borde
            
            // Mover bot√≥n a la izquierda (pegado al borde)
            toggleBtn.classList.remove('left-72');
            toggleBtn.classList.add('left-0');
            
            // Cambiar iconos
            iconCollapse.classList.add('hidden');
            iconExpand.classList.remove('hidden');
        } else {
            // ABRIR
            sidebar.classList.remove('w-0', 'border-none');
            sidebar.classList.add('w-72');
            
            // Mover bot√≥n a su posici√≥n original
            toggleBtn.classList.remove('left-0');
            toggleBtn.classList.add('left-72');
            
            // Cambiar iconos
            iconExpand.classList.add('hidden');
            iconCollapse.classList.remove('hidden');
        }
    }
    </script>
{% endblock %}